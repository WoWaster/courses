% !TEX TS-program = lualatex

% Основано на  презентациях Юрия Викторовича Литвинова:
% https://github.com/yurii-litvinov/courses/tree/master/programming-1st-semester/05-testing
\documentclass[aspectratio=169, russian]{beamer}

\input{../preamble.tex}

% \usepackage{xurl}

%%% Meta

\title{Тестирование и отладка}
\subtitle{Галопом по Европам}
% \author{Николай Пономарев}
% \date{3 ноября 2025 г.}
\date{}
\titlegraphic{\includegraphics[height=1cm]{../фирменный блок_серый.pdf}}
\subject{Отладка и тестирование. Практика по пользованию отладчиком. Понятия неопределенного (undefined) и не специфицированного (unspecified) поведения. Понятие модульных тестов.}

\begin{document}

\begin{frame}[plain, noframenumbering]
    \titlepage
\end{frame}

\begin{frame}
    \frametitle{Тестирование}

    \uncover<+->{Уже было в соседнем курсе, но повторим ещё раз}

    \vspace{1em}

    \begin{uncoverenv}<+->
        \begin{itemize}
            \item Любая программа содержит ошибки
            \item Если программа не содержит ошибок, их содержит алгоритм, который реализует эта программа
            \item Если ни программа, ни алгоритм ошибок не содержат, такая программа даром никому не нужна
        \end{itemize}

        \vspace{1em}

        Тестирование не позволяет доказать отсутствие ошибок, оно позволяет лишь найти ошибки, которые в программе присутствуют
    \end{uncoverenv}

\end{frame}


\begin{frame}{Тестирование в Си}

    \begin{itemize}
        \item Обширная экосистема для тестирования
              \begin{itemize}
                  \item GoogleTest
                  \item cmocka
                  \item Unity Test
                  \item ...
              \end{itemize}
        \item НО довольно сложная в настройке и использовании
        \item Пойдём по простому пути
    \end{itemize}
    % Есть googletest, есть cmocka, есть unity; всё это можно интегрировать с CMake.

    % НО это сложно, поэтому будем делать по рабоче-крестьянски.

\end{frame}

\begin{frame}[fragile]
    \frametitle{Пример типичного теста}

    \begin{minted}[fontsize=\footnotesize]{c}
bool balanceOfParentheses(const char* parentheses)
{
    ...
}
bool testCorrectCase()
{
    return balanceOfParentheses("()");
}
bool testIncorrectCases()
{
    return !balanceOfParentheses("((") && !balanceOfParentheses(")(") ;
}
int main(void) {
    if (!testCorrectCase() || !testIncorrectCases()) {
        printf("Tests failed\n");
        return 1;
    }
    return 0;
}
    \end{minted}
\end{frame}

\begin{frame}
    \frametitle{Undefined \& unspecified behavior\footnote{Определения из стандарта: \url{https://www.open-std.org/JTC1/SC22/WG14/www/docs/n3220.pdf}}}

    \begin{definition}[Unspecified behavior]
        behavior, that results from the use of an unspecified value, or other behavior upon which this document provides two or more possibilities and imposes no further requirements on which is chosen in any instance
    \end{definition}

    \begin{definition}[Undefined behavior (UB)]
        behavior, upon use of a nonportable or erroneous program construct or of erroneous data, for which this document imposes no requirements
    \end{definition}

\end{frame}

\begin{frame}
    \frametitle{Примеры unspecified behavior}

    \begin{itemize}
        \item Код завершения, возвращаемый в среду выполнения, если тип возвращаемого значения функции \texttt{main} не совместим с \texttt{int}
        \item Многие аспекты внутреннего представления типов данных
        \item Порядок вычисления аргументов функции
        \item Порядок и непрерывность памяти, выделяемой последовательными вызовами функций \texttt{calloc}, \texttt{malloc}, \texttt{realloc} и \texttt{aligned\_alloc}
    \end{itemize}


\end{frame}

\begin{frame}
    \frametitle{Примеры undefined behavior}

    \begin{itemize}
        \item Разыменование нулевого указателя
        \item Возникновение исключительной ситуации при вычислении выражения (например, если результат математически не определён или не попадает в диапазон представимых значений для своего типа)
        \item Использование значения указателя на объект, время жизни которого завершилось
        \item Два объявления одного и того же объекта или функции с несовместимыми типами
        \item Сложение или вычитание указателя на объект массива (или сразу за ним) и целочисленного типа, которое даёт результат, указывающий не на тот же массив (или сразу за ним)
    \end{itemize}

\end{frame}

\begin{frame}
    \frametitle{Отладка}
    \begin{itemize}
        \item Устойчивое воспроизведение ошибки
              \begin{itemize}
                  \item Вместо \mintinline{c}|srand(time(NULL))|~--- \mintinline{c}|srand(<какое-то фиксированное значение>)|
                  \item Ошибка должна воспроизводиться быстро
              \end{itemize}
        \item Локализация ошибки
              \begin{itemize}
                  \item Аналитически
                  \item Отладка
              \end{itemize}
        \item Отладочная гипотеза
              \begin{itemize}
                  \item Похоже на научный подход --- гипотеза, эксперимент, уточнение, эксперимент и т.д.
                  \item Тестовый прогон с отладочной печатью
                  \item Тестовый прогон под отладчиком
              \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{gdb}

    gdb (the GNU Project debugger)~--- отладчик проекта GNU, поддерживающий огромное количество архитектур и операционных систем

    \begin{itemize}
        \item В основном консольный
        \item Есть псевдо-графический режим (см. tui)
        \item Может интегрироваться с VS Code
    \end{itemize}

\end{frame}

\begin{frame}
    \frametitle{Отладка с gdb}

    \begin{itemize}
        \item Приложение должно быть собрано с флагом \texttt{-g}
              \begin{itemize}
                  \item Сравните приложение собранное с \texttt{-g} и без него при помощи \texttt{objdump -S}
              \end{itemize}
        \item Запускать как \mintinline{console}|$ gdb <executable>|
        \item Некоторые полезные команды
              \begin{itemize}
                  \item \texttt{run}~--- Запустить программу
                  \item \texttt{break <название> (b <название>)}~--- Установить точку останова
                  \item \texttt{delete <номер> (d <номер>)}~--- Удалить точку останова
                  \item \texttt{step (s)}~--- Сделать шаг исполнения (step into)
                  \item \texttt{next (n)}~--- Сделать шаг исполнения, не заходя в функции (step over)
                  \item \texttt{continue (c)}~--- Продолжить исполнение
                  \item \texttt{print <название>}~--- Вывести значение переменной
                  \item \texttt{backtrace (bt)}~--- Обратная трассировка (после падения)
                  \item \texttt{set history save}~--- Запоминать историю (полезно прописать в .gdbinit)
              \end{itemize}
    \end{itemize}

\end{frame}

\begin{frame}
    \frametitle{Домашнее задание}

    Написать тесты к домашке \enquote{Сортированный список}.

    Тесты должны запускаться по флагу \texttt{--test}, переданному исполняемому файлу.

    Также можно настроить запуск тестов через ctest (см. \url{https://coderefinery.github.io/cmake-workshop/testing/})

    Не забывайте проверять граничные случаи.

    Предпочтительно сдавать в отдельной ветке.
\end{frame}

\end{document}
